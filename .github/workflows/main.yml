name: 航空订单系统 - CI/CD 部署流水线

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_IMAGE_NAME: airline-order-system
  AWS_REGION: us-east-1

jobs:
  # 第一阶段：代码质量检查和测试
  test:
    name: 代码测试和质量检查
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Java 环境
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: 设置 Node.js 环境
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: 缓存 Maven 依赖
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: 前端依赖安装和测试
      working-directory: ./frontend
      run: |
        npm ci
        npm run test -- --watch=false --browsers=ChromeHeadless
        npm run build
        
    - name: 后端测试
      working-directory: ./backend
      run: |
        mvn clean test
        
    - name: 代码覆盖率报告
      working-directory: ./backend
      run: |
        mvn jacoco:report
        
  # 第二阶段：构建和推送Docker镜像
  build-and-push:
    name: 构建并推送Docker镜像
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: 登录 Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: 构建并推送 Docker 镜像
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        platforms: linux/amd64,linux/arm64
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: 镜像安全扫描
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: 上传安全扫描结果
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # 第三阶段：部署到AWS EC2
  deploy:
    name: 部署到 AWS EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 部署到 EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "开始部署航空订单系统..."
          
          # 创建部署目录
          mkdir -p ~/airline-deployment
          cd ~/airline-deployment
          
          # 停止现有服务
          if [ -f docker-compose.yml ]; then
            echo "停止现有服务..."
            docker-compose down
          fi
          
          # 拉取最新镜像
          echo "拉取最新Docker镜像..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # 启动服务
          echo "启动服务..."
          docker-compose up -d --remove-orphans
          
          # 等待服务启动
          echo "等待服务启动..."
          sleep 30
          
          # 健康检查
          echo "执行健康检查..."
          for i in {1..10}; do
            if curl -f http://localhost:8080/actuator/health; then
              echo "服务启动成功！"
              break
            else
              echo "等待服务启动... ($i/10)"
              sleep 10
            fi
          done
          
          # 清理旧镜像
          echo "清理旧Docker镜像..."
          docker image prune -f
          
          echo "部署完成！"
          
    - name: 部署状态通知
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          航空订单系统部署状态: ${{ job.status }}
          分支: ${{ github.ref }}
          提交: ${{ github.sha }}
          作者: ${{ github.actor }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # 第四阶段：部署后测试
  post-deploy-test:
    name: 部署后集成测试
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 等待服务完全启动
      run: sleep 60
      
    - name: 健康检查测试
      run: |
        echo "执行健康检查..."
        curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health
        
    - name: API接口测试
      run: |
        echo "测试主要API接口..."
        # 测试登录接口
        curl -X POST http://${{ secrets.EC2_HOST }}:8080/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username":"test","password":"test"}' || true
          
        # 测试航班查询接口
        curl -f http://${{ secrets.EC2_HOST }}:8080/api/flights || true
        
    - name: 前端页面测试
      run: |
        echo "测试前端页面..."
        curl -f http://${{ secrets.EC2_HOST }}:8080/ | grep -q "航空订单" || true
        
    - name: 性能测试
      run: |
        echo "执行简单性能测试..."
        for i in {1..10}; do
          curl -w "@curl-format.txt" -o /dev/null -s http://${{ secrets.EC2_HOST }}:8080/
        done
      env:
        CURL_FORMAT: |
          time_namelookup:  %{time_namelookup}\n
          time_connect:     %{time_connect}\n
          time_appconnect:  %{time_appconnect}\n
          time_pretransfer: %{time_pretransfer}\n
          time_redirect:    %{time_redirect}\n
          time_starttransfer: %{time_starttransfer}\n
          time_total:       %{time_total}\n
