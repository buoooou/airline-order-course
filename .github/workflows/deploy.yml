name: ğŸ›« èˆªç©ºè®¢å•ç³»ç»Ÿ - CI/CDéƒ¨ç½²

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-2
  ECR_REPOSITORY: airline-order-app
  AWS_ACCOUNT_ID: 381492153714

jobs:
  # æµ‹è¯•é˜¶æ®µ
  test:
    name: ğŸ§ª ä»£ç æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½® JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
      run: |
        cd frontend
        npm ci --legacy-peer-deps
        npm run build -- --configuration=production --ssr=false
    
    - name: ğŸ—ï¸ æ„å»ºåç«¯
      run: |
        cd backend
        mvn clean package -DskipTests -B

  # æ„å»ºDockeré•œåƒ
  build:
    name: ğŸ³ æ„å»ºé•œåƒ
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ”‘ ç™»å½•åˆ° ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: ğŸ³ æ„å»ºå¹¶æ¨é€é•œåƒ
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # æ„å»ºé•œåƒ
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        
        # æ¨é€é•œåƒ
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "é•œåƒæ„å»ºå®Œæˆ: $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  # éƒ¨ç½²åˆ°EC2
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ”§ é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ”‘ ç™»å½•åˆ° ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: ğŸš€ éƒ¨ç½²åˆ° EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        port: 22
        envs: ECR_REGISTRY,ECR_REPOSITORY,DB_HOST,DB_PASSWORD,JWT_SECRET
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          export ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
          export DB_HOST=${{ secrets.DB_HOST }}
          export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          export JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          echo "ğŸ”„ å¼€å§‹éƒ¨ç½²èˆªç©ºè®¢å•ç³»ç»Ÿ..."
          
          # åˆ›å»ºåº”ç”¨ç›®å½•
          sudo mkdir -p /opt/airline-order
          sudo chown $USER:$USER /opt/airline-order
          cd /opt/airline-order
          
          # ç™»å½•ECR
          echo "ğŸ”‘ ç™»å½•åˆ°ECR..."
          aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin $ECR_REGISTRY
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "â¹ï¸ åœæ­¢ç°æœ‰æœåŠ¡..."
          docker-compose down || true
          
          # åˆ›å»ºdocker-compose.yml
          echo "ğŸ“ åˆ›å»ºé…ç½®æ–‡ä»¶..."
          cat > docker-compose.yml << EOF
          version: '3.8'
          services:
            nginx:
              image: nginx:alpine
              ports:
                - "80:80"
              volumes:
                - ./nginx.conf:/etc/nginx/conf.d/default.conf
              depends_on:
                - backend
              restart: unless-stopped
              networks:
                - airline-network
          
            backend:
              image: $ECR_REGISTRY/$ECR_REPOSITORY:latest
              ports:
                - "8080:8080"
              environment:
                - SPRING_PROFILES_ACTIVE=prod
                - SPRING_DATASOURCE_URL=jdbc:mysql://$DB_HOST:3306/airline_order_db?useSSL=true&serverTimezone=UTC&allowPublicKeyRetrieval=true
                - SPRING_DATASOURCE_USERNAME=airline_app
                - SPRING_DATASOURCE_PASSWORD=$DB_PASSWORD
                - JWT_SECRET=$JWT_SECRET
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
              restart: unless-stopped
              networks:
                - airline-network
          
          networks:
            airline-network:
              driver: bridge
          EOF
          
          # åˆ›å»ºNginxé…ç½®
          cat > nginx.conf << 'EOF'
          server {
              listen 80;
              server_name _;
              
              # å¥åº·æ£€æŸ¥
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
              
              # APIä»£ç†
              location /api/ {
                  proxy_pass http://backend:8080/;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  
                  # CORSé…ç½®
                  add_header Access-Control-Allow-Origin * always;
                  add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                  add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
                  
                  if (\$request_method = 'OPTIONS') {
                      add_header Access-Control-Allow-Origin *;
                      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                      add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
                      add_header Access-Control-Max-Age 1728000;
                      add_header Content-Type 'text/plain; charset=utf-8';
                      add_header Content-Length 0;
                      return 204;
                  }
              }
              
              # Swagger UI
              location /swagger-ui/ {
                  proxy_pass http://backend:8080/swagger-ui/;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
              
              # APIæ–‡æ¡£
              location /api-docs/ {
                  proxy_pass http://backend:8080/api-docs/;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
              
              # é»˜è®¤é¡µé¢
              location / {
                  return 200 '<!DOCTYPE html>
          <html>
          <head>
              <title>ğŸ›« èˆªç©ºè®¢å•ç³»ç»Ÿ</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                  .container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px); }
                  h1 { text-align: center; font-size: 2.5em; margin-bottom: 30px; }
                  .status { padding: 15px; margin: 20px 0; border-radius: 10px; backdrop-filter: blur(5px); }
                  .success { background: rgba(40, 167, 69, 0.3); border: 1px solid rgba(40, 167, 69, 0.5); }
                  .info { background: rgba(23, 162, 184, 0.3); border: 1px solid rgba(23, 162, 184, 0.5); }
                  .links { margin: 30px 0; text-align: center; }
                  .links a { display: inline-block; margin: 10px; padding: 12px 25px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 25px; transition: all 0.3s; }
                  .links a:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
                  .footer { text-align: center; margin-top: 30px; opacity: 0.8; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ›« èˆªç©ºè®¢å•ç³»ç»Ÿ</h1>
                  <div class="status success">
                      âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸
                  </div>
                  <div class="status info">
                      ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)<br>
                      ğŸ·ï¸ ç‰ˆæœ¬: latest<br>
                      ğŸŒ ç¯å¢ƒ: AWSç”Ÿäº§ç¯å¢ƒ<br>
                      ğŸŒ åŒºåŸŸ: us-east-2 (ä¿„äº¥ä¿„å·)
                  </div>
                  <div class="links">
                      <a href="/api-docs" target="_blank">ğŸ“š APIæ–‡æ¡£</a>
                      <a href="/swagger-ui/index.html" target="_blank">ğŸ”§ Swagger UI</a>
                      <a href="/api/actuator/health" target="_blank">ğŸ’š å¥åº·æ£€æŸ¥</a>
                  </div>
                  <div class="footer">
                      <p>ğŸš€ ç”± GitHub Actions è‡ªåŠ¨éƒ¨ç½²</p>
                  </div>
              </div>
          </body>
          </html>';
                  add_header Content-Type text/html;
              }
          }
          EOF
          
          # å¯åŠ¨æœåŠ¡
          echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
          docker-compose up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          docker-compose ps
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ’š æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          for i in {1..10}; do
              if curl -f http://localhost:8080/actuator/health; then
                  echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
                  break
              else
                  echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/10)"
                  sleep 10
              fi
          done
          
          # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://$PUBLIC_IP"
          echo "ğŸ“š APIæ–‡æ¡£: http://$PUBLIC_IP/swagger-ui/index.html"
          echo "ğŸ’š å¥åº·æ£€æŸ¥: http://$PUBLIC_IP/api/actuator/health"
    
    - name: ğŸ§ª éƒ¨ç½²åæµ‹è¯•
      run: |
        echo "ğŸ§ª æ‰§è¡Œéƒ¨ç½²åæµ‹è¯•..."
        sleep 60
        
        # æµ‹è¯•å¥åº·æ£€æŸ¥
        if curl -f http://${{ secrets.EC2_HOST }}/api/actuator/health; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        echo "ğŸ‰ éƒ¨ç½²å’Œæµ‹è¯•å®Œæˆï¼"
        echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.EC2_HOST }}"
