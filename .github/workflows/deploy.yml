
name: CI/CD for Angular and Spring Boot

on:
  push:
    branches:
      - main  # è§¦å‘éƒ¨ç½²çš„åˆ†æ”¯

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      db:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: airlineorder
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒï¼ˆç”¨äºŽ Angular æž„å»ºï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      # 3. å®‰è£… Angular ä¾èµ–å¹¶æž„å»º       
      - name: Build airline-order-frontend
        run: |
          cd airline-order-frontend
      
          # âœ… 1. æ£€æŸ¥æºæ–‡ä»¶
          if [ ! -f "src/index.html" ]; then
            echo "âŒ ERROR: src/index.html does NOT exist!"
            ls -la src/
            exit 1
          else
            echo "âœ… src/index.html exists"
          fi
      
          # âœ… 2. å®‰è£…ä¾èµ–
          npm ci
      
          # âœ… 3. æž„å»º
          npx ng build --configuration=production
      
          # âœ… 4. éªŒè¯æž„å»ºè¾“å‡ºï¼ˆæœ€å…³é”®ï¼ï¼‰
          if [ ! -f "dist/airline-order-frontend/index.html" ]; then
            echo "âŒ ERROR: index.html was NOT generated after build!"
            echo "ðŸ‘‰ This means Angular build didn't create it, even though 'Building...' succeeded."
            echo "ðŸ” Checking what's in dist/:"
            ls -la dist/airline-order-frontend/ || echo "dist/ directory missing"
            exit 1
          else
            echo "âœ… SUCCESS: index.html generated at dist/airline-order-frontend/index.html"
          fi

      - name: Deploy to EC2 via rsync
        run: |
          # ...
          rsync -avz --delete ./airline-order-frontend/dist/airline-order-frontend/ ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/app/frontend/

      # 4. è®¾ç½® Java çŽ¯å¢ƒï¼ˆç”¨äºŽ Spring Boot æž„å»ºï¼‰
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 5. æž„å»º Spring Boot é¡¹ç›®
      - name: Build airline-order-backend
        run: |
          cd airline-order-backend
          chmod +x ./mvnw
          ./mvnw clean install

      # 6. åœ¨ EC2 ä¸Šå®‰è£… Node.js å’Œ npm
      - name: Install Node.js and npm on EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts
      
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} "
            sudo apt-get update && sudo apt-get install -y nodejs npm
          "

      # 7. è®¾ç½® PATHï¼ˆå¯é€‰ï¼Œé€šå¸¸ä¸éœ€è¦ï¼‰
      - name: Set PATH for Node.js and npm
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} "
            echo 'export PATH=$PATH:/usr/bin' >> ~/.bashrc && source ~/.bashrc
          "

      # 8. éƒ¨ç½²åˆ° EC2ï¼šä½¿ç”¨ rsync åŒæ­¥æž„å»ºäº§ç‰©
      - name: Deploy to EC2 via rsync
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts
      
          # åˆ›å»ºè¿œç¨‹ç›®å½•
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} "
            mkdir -p /home/ubuntu/app/frontend /home/ubuntu/app/backend
          "
      
          # âœ… ä¿®å¤ï¼šåŒæ­¥ dist/airline-order-frontend/ çš„å†…å®¹
          rsync -avz --delete ./airline-order-frontend/dist/airline-order-frontend/ ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/app/frontend/
      
          # åŒæ­¥åŽç«¯ JAR
          rsync -avz --delete ./airline-order-backend/target/*.jar ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/app/backend/

      # 9. åœ¨ EC2 ä¸Šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
      - name: Run Deployment Script on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            # ç¡®ä¿ http-server å·²å®‰è£…
            if ! command -v http-server &> /dev/null; then
              sudo npm install -g http-server
            fi

            # åœæ­¢æ—§å‰ç«¯æœåŠ¡
            pkill -f "http-server" || true

            # âœ… å¯åŠ¨å‰ç«¯æœåŠ¡ï¼Œå¸¦æ—¥å¿—
            nohup http-server /home/ubuntu/app/frontend -p 8080 > /home/ubuntu/app/frontend.log 2>&1 &

            # åœæ­¢æ—§åŽç«¯æœåŠ¡
            pkill -f "java -jar" || true

            # âœ… å¯åŠ¨åŽç«¯æœåŠ¡ï¼Œå¸¦æ—¥å¿—
            nohup java -jar /home/ubuntu/app/backend/*.jar > /home/ubuntu/app/backend.log 2>&1 &

