name: CI/CD for Angular and Spring Boot

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------
      # æ„å»º Angular å‰ç«¯
      # ----------------------------
      - name: Setup Node.js (Angular)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install frontend dependencies
        run: |
          cd airline-order-frontend
          npm ci

      - name: Build Angular (Production)
        run: |
          cd airline-order-frontend
          npx ng build --configuration=production

      # ----------------------------
      # æ„å»º Spring Boot åç«¯
      # ----------------------------
      - name: Setup Java (Spring Boot)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Spring Boot JAR
        run: |
          cd airline-order-backend
          chmod +x ./mvnw
          ./mvnw clean package -DskipTests

      # ----------------------------
      # ä¿å­˜æ„å»ºäº§ç‰©ä¾›éƒ¨ç½²ä½¿ç”¨
      # ----------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            airline-order-frontend/dist/
            airline-order-backend/target/*.jar

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      # ----------------------------
      # SSH è®¾ç½®ï¼ˆé›†ä¸­ä¸€æ¬¡å®Œæˆï¼‰
      # ----------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      # ----------------------------
      # ä½¿ç”¨ rsync éƒ¨ç½²å‰åç«¯
      # ----------------------------
      - name: Deploy to EC2 via rsync
        run: |
          # åˆ›å»ºè¿œç¨‹ç›®å½•
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} \
            "mkdir -p /home/ubuntu/app/frontend /home/ubuntu/app/backend"

          # åŒæ­¥å‰ç«¯
          rsync -avz --delete ./dist/ ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/app/frontend/

          # åŒæ­¥åç«¯ JARï¼ˆç¡®ä¿åªæœ‰ä¸€ä¸ª JARï¼‰
          JAR_FILE=$(ls *.jar | head -n1)
          rsync -avz --delete "$JAR_FILE" ${{ secrets.AWS_EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }}:/home/ubuntu/app/backend/app.jar

      # ----------------------------
      # è¿œç¨‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬
      # ----------------------------
      - name: Run Deployment Script on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.AWS_EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
      
            # ================================
            # 1. å®‰è£… MySQLï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            # ================================
            if ! command -v mysql &> /dev/null; then
              echo "Installing MySQL Server..."
      
              # é¢„é…ç½® root å¯†ç ä¸º 'root'
              sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password password root'
              sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password root'
      
              sudo apt update
              sudo apt install -y mysql-server
              echo "âœ… MySQL installed with root password = 'root'"
            fi
      
            # ================================
            # 2. å¯åŠ¨å¹¶å¯ç”¨ MySQL
            # ================================
            sudo systemctl start mysql
            sudo systemctl enable mysql
      
            # ================================
            # 3. åˆ›å»ºæ•°æ®åº“ airlineorderï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            # ================================
            sudo mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS airlineorder CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
      
            # ================================
            # 4. ç¡®ä¿ root ç”¨æˆ·å¯ä»¥ä» localhost ç™»å½•
            # ================================
            # é»˜è®¤æƒ…å†µä¸‹ root å·²ç»å¯ä»¥æœ¬åœ°ç™»å½•ï¼Œä½†å¦‚æœä½ é‡åˆ°èº«ä»½éªŒè¯é—®é¢˜ï¼Œå¯ä»¥é‡ç½®ï¼š
            sudo mysql -u root -proot -e "
              ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';
              FLUSH PRIVILEGES;
            "
      
            # ================================
            # 5. ï¼ˆå¯é€‰ï¼‰å…è®¸ root ä»ä»»æ„ä¸»æœºè¿æ¥ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼ä¸å®‰å…¨ï¼‰
            # ================================
            # å¦‚æœä½ å°†æ¥æƒ³ä»å¤–éƒ¨è®¿é—®æ•°æ®åº“ï¼Œå–æ¶ˆä¸‹è¿°æ³¨é‡Š
            # sudo mysql -u root -proot -e "
            #   CREATE USER IF NOT EXISTS 'root'@'%' IDENTIFIED BY 'root';
            #   GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
            #   FLUSH PRIVILEGES;
            # "
            # sudo sed -i 's/bind-address.*/bind-address = 0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf
            # sudo systemctl restart mysql
      
            # ================================
            # 6. å®‰è£…å‰ç«¯æœåŠ¡å·¥å…· http-server
            # ================================
            if ! command -v http-server &> /dev/null; then
              echo "Installing http-server..."
              sudo npm install -g http-server
            fi
      
            # ================================
            # 7. åœæ­¢æ—§æœåŠ¡
            # ================================
            echo "Stopping old frontend..."
            pkill -f "http-server" || true
      
            echo "Stopping old backend..."
            pkill -f "java -jar" || true
      
            # ================================
            # 8. å¯åŠ¨å‰ç«¯æœåŠ¡
            # ================================
            nohup http-server /home/ubuntu/app/frontend -p 8080 \
              > /home/ubuntu/app/frontend/server.log 2>&1 &
      
            # ================================
            # 9. å¯åŠ¨ Spring Boot åç«¯
            # ================================
            nohup java -jar /home/ubuntu/app/backend/app.jar \
              --spring.profiles.active=prod \
              > /home/ubuntu/app/backend/app.log 2>&1 &
      
            # ================================
            # 10. éªŒè¯æœåŠ¡æ˜¯å¦å¯åŠ¨
            # ================================
            sleep 8
            if pgrep -f "http-server" > /dev/null; then
              echo "ğŸŸ¢ Frontend is running on port 8080"
            else
              echo "âŒ Frontend failed to start!"
              exit 1
            fi
      
            if pgrep -f "java -jar" > /dev/null; then
              echo "ğŸŸ¢ Backend is running"
            else
              echo "âŒ Backend failed to start!"
              exit 1
            fi
      
            echo "âœ… Deployment completed successfully! Database 'airlineorder' ready with root/root."
