name: ğŸ›« èˆªç©ºè®¢å•ç³»ç»Ÿ - AWSè‡ªåŠ¨éƒ¨ç½²æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-2  # ä¿„äº¥ä¿„å·åŒºåŸŸ
  ECR_REPOSITORY: airline-order-app
  AWS_ACCOUNT_ID: 381492153714

jobs:
  # ğŸ§ª ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    name: ğŸ§ª æµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½® JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: ğŸŸ¢ è®¾ç½® Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd frontend
        npm ci --legacy-peer-deps
    
    - name: ğŸ” å‰ç«¯ä»£ç æ£€æŸ¥
      run: |
        cd frontend
        npm run lint || echo "Lintæ£€æŸ¥å®Œæˆï¼Œå­˜åœ¨è­¦å‘Š"
    
    - name: ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•
      run: |
        cd frontend
        npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage || echo "å‰ç«¯æµ‹è¯•å®Œæˆ"
    
    - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
      run: |
        cd frontend
        npm run build -- --configuration=production --ssr=false
    
    - name: ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•
      run: |
        cd backend
        mvn clean test -B || echo "åç«¯æµ‹è¯•å®Œæˆ"
    
    - name: ğŸ—ï¸ æ„å»ºåç«¯
      run: |
        cd backend
        mvn clean package -DskipTests -B
    
    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          backend/target/surefire-reports/
          frontend/coverage/
    
    - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          backend/target/*.jar
          frontend/dist/

  # ğŸ”’ å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ” è¿è¡Œ Trivy æ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ğŸ“Š ä¸Šä¼ æ‰«æç»“æœåˆ° GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # ğŸ³ æ„å»ºå’Œæ¨é€Dockeré•œåƒ
  build-image:
    name: ğŸ³ æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ”‘ ç™»å½•åˆ° Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: ğŸ·ï¸ æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: ğŸ”§ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    name: ğŸš€ éƒ¨ç½²åˆ°AWSç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ”‘ ç™»å½•åˆ° Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: ğŸš€ éƒ¨ç½²åˆ° EC2 ç”Ÿäº§ç¯å¢ƒ
      env:
        PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        HOSTNAME: ${{ secrets.EC2_HOST }}
        USER_NAME: ${{ secrets.EC2_USERNAME }}
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: |
        # åˆ›å»ºç§é’¥æ–‡ä»¶
        echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸ”„ å¼€å§‹éƒ¨ç½²èˆªç©ºè®¢å•ç³»ç»Ÿ..."
        
        # é…ç½®AWSåŒºåŸŸ
        export AWS_DEFAULT_REGION=us-east-2
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        sudo mkdir -p /opt/airline-order
        sudo chown $USER:$USER /opt/airline-order
        cd /opt/airline-order
        
        # ç™»å½•ECR
        echo "ğŸ”‘ ç™»å½•åˆ°ECR..."
        aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin $ECR_REGISTRY
        
        # æ‹‰å–æœ€æ–°é•œåƒ
        echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
        docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # åœæ­¢ç°æœ‰æœåŠ¡
        echo "â¹ï¸ åœæ­¢ç°æœ‰æœåŠ¡..."
        docker-compose down || true
        
        # åˆ›å»ºdocker-compose.yml
        echo "ğŸ“ åˆ›å»ºé…ç½®æ–‡ä»¶..."
        cat > docker-compose.yml << 'COMPOSE_EOF'
        version: '3.8'
        services:
          nginx:
            image: nginx:alpine
            ports:
              - "80:80"
            volumes:
              - ./nginx.conf:/etc/nginx/conf.d/default.conf
            depends_on:
              - backend
            restart: unless-stopped
            networks:
              - airline-network
        
          backend:
            image: $ECR_REGISTRY/$ECR_REPOSITORY:latest
            ports:
              - "8080:8080"
            environment:
              - SPRING_PROFILES_ACTIVE=prod
              - SPRING_DATASOURCE_URL=jdbc:mysql://$DB_HOST:3306/airline_order_db?useSSL=true&serverTimezone=UTC&allowPublicKeyRetrieval=true
              - SPRING_DATASOURCE_USERNAME=airline_app
              - SPRING_DATASOURCE_PASSWORD=$DB_PASSWORD
              - JWT_SECRET=$JWT_SECRET
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
              interval: 30s
              timeout: 10s
              retries: 3
              start_period: 60s
            restart: unless-stopped
            networks:
              - airline-network
        
        networks:
          airline-network:
            driver: bridge
        COMPOSE_EOF
        
        # åˆ›å»ºNginxé…ç½®
        cat > nginx.conf << 'NGINX_EOF'
        server {
            listen 80;
            server_name _;
            
            # å¥åº·æ£€æŸ¥
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
            
            # APIä»£ç†
            location /api/ {
                proxy_pass http://backend:8080/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # CORSé…ç½®
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
                
                if ($request_method = 'OPTIONS') {
                    add_header Access-Control-Allow-Origin *;
                    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
                    add_header Access-Control-Max-Age 1728000;
                    add_header Content-Type 'text/plain; charset=utf-8';
                    add_header Content-Length 0;
                    return 204;
                }
            }
            
            # Swagger UI
            location /swagger-ui/ {
                proxy_pass http://backend:8080/swagger-ui/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            # APIæ–‡æ¡£
            location /api-docs/ {
                proxy_pass http://backend:8080/api-docs/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            # é»˜è®¤é¡µé¢
            location / {
                return 200 '<!DOCTYPE html>
        <html>
        <head>
            <title>ğŸ›« èˆªç©ºè®¢å•ç³»ç»Ÿ</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                .container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px); }
                h1 { text-align: center; font-size: 2.5em; margin-bottom: 30px; }
                .status { padding: 15px; margin: 20px 0; border-radius: 10px; backdrop-filter: blur(5px); }
                .success { background: rgba(40, 167, 69, 0.3); border: 1px solid rgba(40, 167, 69, 0.5); }
                .info { background: rgba(23, 162, 184, 0.3); border: 1px solid rgba(23, 162, 184, 0.5); }
                .links { margin: 30px 0; text-align: center; }
                .links a { display: inline-block; margin: 10px; padding: 12px 25px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 25px; transition: all 0.3s; }
                .links a:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
                .footer { text-align: center; margin-top: 30px; opacity: 0.8; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ›« èˆªç©ºè®¢å•ç³»ç»Ÿ</h1>
                <div class="status success">
                    âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸
                </div>
                <div class="status info">
                    ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)<br>
                    ğŸ·ï¸ ç‰ˆæœ¬: latest<br>
                    ğŸŒ ç¯å¢ƒ: AWSç”Ÿäº§ç¯å¢ƒ<br>
                    ğŸŒ åŒºåŸŸ: us-east-2 (ä¿„äº¥ä¿„å·)
                </div>
                <div class="links">
                    <a href="/api-docs" target="_blank">ğŸ“š APIæ–‡æ¡£</a>
                    <a href="/swagger-ui/index.html" target="_blank">ğŸ”§ Swagger UI</a>
                    <a href="/api/actuator/health" target="_blank">ğŸ’š å¥åº·æ£€æŸ¥</a>
                </div>
                <div class="footer">
                    <p>ğŸš€ ç”± GitHub Actions è‡ªåŠ¨éƒ¨ç½²</p>
                </div>
            </div>
        </body>
        </html>';
                add_header Content-Type text/html;
            }
        }
        NGINX_EOF
        
        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        docker-compose up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        docker-compose ps
        
        # å¥åº·æ£€æŸ¥
        echo "ğŸ’š æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..10}; do
            if curl -f http://localhost:8080/actuator/health; then
                echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
                break
            else
                echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/10)"
                sleep 10
            fi
        done
        
        # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
        PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ è®¿é—®åœ°å€: http://$PUBLIC_IP"
        echo "ğŸ“š APIæ–‡æ¡£: http://$PUBLIC_IP/swagger-ui/index.html"
        echo "ğŸ’š å¥åº·æ£€æŸ¥: http://$PUBLIC_IP/api/actuator/health"
        EOF
        
        # æ‰§è¡Œéƒ¨ç½²
        scp -o StrictHostKeyChecking=no -i private_key deploy.sh ${USER_NAME}@${HOSTNAME}:/tmp/
        ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} "
          chmod +x /tmp/deploy.sh
          ECR_REGISTRY=$ECR_REGISTRY ECR_REPOSITORY=$ECR_REPOSITORY DB_HOST=$DB_HOST DB_PASSWORD=$DB_PASSWORD JWT_SECRET=$JWT_SECRET /tmp/deploy.sh
        "
    
    - name: ğŸ§ª éƒ¨ç½²åæµ‹è¯•
      env:
        HOSTNAME: ${{ secrets.EC2_HOST }}
      run: |
        echo "ğŸ§ª æ‰§è¡Œéƒ¨ç½²åæµ‹è¯•..."
        
        # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        sleep 60
        
        # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
        echo "ğŸ’š æµ‹è¯•å¥åº·æ£€æŸ¥..."
        if curl -f http://$HOSTNAME/api/actuator/health; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        # æµ‹è¯•ä¸»é¡µ
        echo "ğŸ  æµ‹è¯•ä¸»é¡µ..."
        if curl -f http://$HOSTNAME/ | grep -q "èˆªç©ºè®¢å•ç³»ç»Ÿ"; then
          echo "âœ… ä¸»é¡µæµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ ä¸»é¡µæµ‹è¯•å¤±è´¥"
        fi
        
        # æµ‹è¯•APIç«¯ç‚¹
        echo "ğŸ”Œ æµ‹è¯•APIç«¯ç‚¹..."
        if curl -f http://$HOSTNAME/api/flights; then
          echo "âœ… APIæµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ APIæµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²"
        fi
    
    - name: ğŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "âœ… èˆªç©ºè®¢å•ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ°AWSç”Ÿäº§ç¯å¢ƒ"
          echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.EC2_HOST }}"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.EC2_HOST }}/swagger-ui/index.html"
          echo "ğŸ’š å¥åº·æ£€æŸ¥: http://${{ secrets.EC2_HOST }}/api/actuator/health"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥"
          echo "ğŸš¨ èˆªç©ºè®¢å•ç³»ç»Ÿéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

  # ğŸ§¹ æ¸…ç†æ—§é•œåƒ
  cleanup:
    name: ğŸ§¹ æ¸…ç†æ—§é•œåƒ
    runs-on: ubuntu-latest
    needs: [deploy-prod]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ”§ é…ç½® AWS å‡­è¯
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ğŸ§¹ æ¸…ç†æ—§çš„ECRé•œåƒ
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†æ—§é•œåƒ..."
        
        # è·å–æ‰€æœ‰é•œåƒï¼ˆé™¤äº†latestï¼‰
        IMAGES=$(aws ecr list-images --repository-name $ECR_REPOSITORY --region $AWS_REGION \
          --filter tagStatus=TAGGED \
          --query 'imageIds[?imageTag!=`latest`].imageTag' \
          --output text)
        
        # è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        IFS=$'\t' read -ra IMAGE_ARRAY <<< "$IMAGES"
        
        # å¦‚æœé•œåƒæ•°é‡è¶…è¿‡10ä¸ªï¼Œåˆ é™¤æœ€æ—§çš„
        if [ ${#IMAGE_ARRAY[@]} -gt 10 ]; then
          # æ’åºå¹¶è·å–è¦åˆ é™¤çš„é•œåƒ
          printf '%s\n' "${IMAGE_ARRAY[@]}" | sort -V | head -n -10 | while read tag; do
            if [ ! -z "$tag" ] && [ "$tag" != "latest" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤æ—§é•œåƒ: $tag"
              aws ecr batch-delete-image \
                --repository-name $ECR_REPOSITORY \
                --region $AWS_REGION \
                --image-ids imageTag=$tag || true
            fi
          done
          echo "âœ… é•œåƒæ¸…ç†å®Œæˆ"
        else
          echo "â„¹ï¸ é•œåƒæ•°é‡æœªè¶…è¿‡é™åˆ¶ï¼Œæ— éœ€æ¸…ç†"
        fi
